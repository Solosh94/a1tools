# A1 Tools - Windows Build Workflow
# Builds x64 version of the app (works on ARM64 via Windows emulation)
#
# Triggers:
#   - Manual dispatch (workflow_dispatch) with version input
#   - Push to 'release/*' branches
#
# Outputs:
#   - A1-Tools-Setup-{version}.exe

name: Build Windows Installer

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 4.2.70)'
        required: true
        type: string

  push:
    branches:
      - 'release/*'
    paths-ignore:
      - '**.md'
      - 'docs/**'

env:
  FLUTTER_VERSION: '3.38.9'

jobs:
  # ===========================================
  # Build x64 Version (works on Intel/AMD and ARM64 via emulation)
  # ===========================================
  build-x64:
    name: Build Windows x64
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            # Extract version from pubspec.yaml
            VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d '\r\n')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: flutter pub get

      - name: Download WebView2 Fixed Runtime
        shell: pwsh
        run: |
          # Download WebView2 Fixed Version Runtime from NuGet
          $webview2Version = "140.0.3485.81"
          $nugetUrl = "https://www.nuget.org/api/v2/package/Microsoft.Web.WebView2/$webview2Version"
          $zipPath = "webview2.zip"
          $extractPath = "webview2_temp"
          $targetPath = "windows/third_party/WebView2FixedRuntime"

          Write-Host "Downloading WebView2 Fixed Runtime v$webview2Version..."
          Invoke-WebRequest -Uri $nugetUrl -OutFile $zipPath

          Write-Host "Extracting..."
          Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force

          # Create target directory
          New-Item -ItemType Directory -Force -Path $targetPath

          # Copy the x64 runtime files
          $runtimeSource = "$extractPath/runtimes/win-x64/native"
          Copy-Item -Path "$runtimeSource/*" -Destination $targetPath -Recurse -Force

          Write-Host "WebView2 Fixed Runtime installed to $targetPath"
          dir $targetPath

      - name: Build Windows x64
        run: flutter build windows --release --build-name=${{ steps.version.outputs.version }}

      - name: Download VC++ Redistributable
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path installer\redist
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "installer\redist\vc_redist.x64.exe"

      - name: Build Installer with Inno Setup
        shell: pwsh
        run: |
          # Download and install Inno Setup
          choco install innosetup -y

          # Build the installer
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            /DMyAppVersion=${{ steps.version.outputs.version }} `
            /DMyAppExeName=a1_tools.exe `
            /DOutputBaseFilename=A1-Tools-Setup-${{ steps.version.outputs.version }} `
            installer\a1-tools.iss

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: installer
          path: installer/output/A1-Tools-Setup-${{ steps.version.outputs.version }}.exe
          retention-days: 30

  # ===========================================
  # Create Release
  # ===========================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-x64]
    if: success()

    steps:
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/heads/release/}" >> $GITHUB_OUTPUT
          fi

      - name: Download Installer
        uses: actions/download-artifact@v4
        with:
          name: installer
          path: ./installers

      - name: List installers
        run: ls -la ./installers/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: A1 Tools v${{ steps.version.outputs.version }}
          draft: true
          files: |
            ./installers/*.exe
          body: |
            ## A1 Tools v${{ steps.version.outputs.version }}

            ### Download

            **A1-Tools-Setup-${{ steps.version.outputs.version }}.exe**

            This installer works on all Windows PCs including ARM64 laptops (via Windows x64 emulation).

            ### Requirements
            - Windows 10 or later
            - VC++ Redistributable (included in installer)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
